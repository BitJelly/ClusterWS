module.exports=function(e){function t(n){if(r[n])return r[n].exports;var s=r[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.type=e,this.data=t}return e}();t.ProcessMessages=n;var s=function(){function e(e,t,r){this.err=e,this.is=t,this.pid=r}return e}();t.ProcessErrors=s;var o=function(){function e(e,t){this.event=e,this.data=t,this.action="emit"}return e}(),i=function(){function e(e,t){this.channel=e,this.data=t,this.action="publish"}return e}(),c=function(){function e(e,t){this.event=e,this.data=t,this.action="internal"}return e}(),a=function(){function e(e,t){this.channel=e,this.data=t}return e}(),u=function(){function e(){}return e.emitMessage=function(e,t){return JSON.stringify(new o(e,t))},e.publishMessage=function(e,t){return JSON.stringify(new i(e,t))},e.brokerMessage=function(e,t){return JSON.stringify(new a(e,t))},e.internalMessage=function(e,t){return JSON.stringify(new c(e,t))},e.processErrors=function(e,t,r){return new s(e,t,r)},e.processMessages=function(e,t){return new n(e,t)},e}();t.MessageFactory=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._events={}}return e.prototype.on=function(e,t){if(!t)throw"Function must be provided";return this._events[e]||(this._events[e]=[]),this._events[e].push(t)},e.prototype.emit=function(e,t,r,n){if(this._events[e])for(var s=0,o=this._events[e].length;s<o;s++)"function"==typeof this._events[e][s]&&this._events[e][s].call(this,t,r,n)},e.prototype.removeListener=function(e,t){if(this._events[e])for(var r=this._events[e].length;r--;)this._events[e][r]===t&&this._events[e].splice(r,1)},e.prototype.removeEvent=function(e){this._events[e]&&(this._events[e]=null,delete this._events[e])},e.prototype.removeAllEvents=function(){for(var e in this._events)this._events.hasOwnProperty(e)&&(this._events[e]=null,delete this._events[e])},e.prototype.exist=function(e){return this._events[e]},e}();t.EventEmitter=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),s=r(1),o=function(){function e(e,t){var r=this;this.port=e,this.host=t,this.dataBuffer="",this.eventEmitter=new s.EventEmitter,e instanceof n.Socket?this.socket=e:this.socket=n.connect(e,t),this.socket.on("connect",function(){r.emit("connect")}),this.socket.on("data",function(e){var t=e.toString(),n=t.indexOf("\n");if(-1===n)return void(r.dataBuffer+=t);r.emit("message",r.dataBuffer+t.slice(0,n));for(var s=n+1;-1!==(n=e.indexOf("\n",s));)r.emit("message",t.slice(s,n)),s=n+1;r.dataBuffer=t.slice(s)}),this.socket.on("end",function(){r.emit("disconnect")}),this.socket.on("error",function(e){r.emit("error",e)})}return e.prototype.send=function(e){this.socket.write(e+"\n")},e.prototype.on=function(e,t){this.eventEmitter.on(e,t)},e.prototype.emit=function(e,t){this.eventEmitter.emit(e,t)},e}();t.TcpSocket=o},function(e,t){e.exports=require("net")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(5),s=r(7),o=function(){function e(e){this.configurations=e,this.configurations=this.configurations||{},this.options=new n.Options(e),this.servers=s.Servers(this.options)}return e}();t.ClusterWS=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(6),s=function(){function e(e){if(!e.pathToWorker)throw new Error("[31mPath to the worker must be provided[0m");this.port=e.port||3e3,this.workers=e.workers||1,this.brokerPort=e.brokerPort||9346,this.pathToWorker=n.resolve(e.pathToWorker),this.pingInterval=e.pingInterval||2e4,this.restartWorkerOnFail=e.restartWorkerOnFail||!1}return e}();t.Options=s},function(e,t){e.exports=require("path")},function(module,exports,__webpack_require__){"use strict";function Servers(options){if(cluster.isMaster){var broker=void 0,workers_1,initWorkerMsg_1;console.log("[36m%s[0m",">>> Master on: "+options.port+", PID "+process.pid);var handleChildMessages_1=function(e){e.on("message",function(e){"error"===e.type&&console.error("[31m%s[0m",e.data.is+", PID "+e.data.pid+"\n"+e.data.err+"\n")})},launchWorker_1=function(e){var t=workers_1[e]=cluster.fork();initWorkerMsg_1.data.id=e,t.on("exit",function(){options.restartWorkerOnFail&&(console.log("[33m%s[0m","Restarting worker on fail "+initWorkerMsg_1.data.id),launchWorker_1(e))}),handleChildMessages_1(t),t.send(initWorkerMsg_1)};workers_1=new Array(options.workers),initWorkerMsg_1=messages_1.MessageFactory.processMessages("initWorker",options),broker=cluster.fork(),handleChildMessages_1(broker),broker.send(messages_1.MessageFactory.processMessages("initBroker",options));for(var i=0;i<options.workers;i++)launchWorker_1(i)}else{var server;process.on("message",function(message){"initWorker"===message.type&&(server=new worker_1.Worker(message.data),server.is="Worker",eval("require")(message.data.pathToWorker)(server)),"initBroker"===message.type&&(server=new broker_1.Broker(message.data),server.is="Broker")}),process.on("uncaughtException",function(e){process.send(messages_1.MessageFactory.processMessages("error",messages_1.MessageFactory.processErrors(e.toString(),server.is,process.pid))),process.exit()})}}Object.defineProperty(exports,"__esModule",{value:!0});var cluster=__webpack_require__(8),messages_1=__webpack_require__(0),worker_1=__webpack_require__(9),broker_1=__webpack_require__(13);exports.Servers=Servers},function(e,t){e.exports=require("cluster")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(10),s=r(11),o=r(12),i=r(2),c=r(1),a=r(0),u=function(){function e(e){this.options=e,this.id=this.options.id,this.eventEmitter=new c.EventEmitter,this._connectBroker(),this._connectHttpServer(),this._connectWebSocketServer()}return e.prototype.on=function(e,t){this.eventEmitter.on(e,t)},e.prototype.emit=function(e,t){this.eventEmitter.emit(e,t)},e.prototype._unsubscribe=function(e,t){this.eventEmitter.removeListener(e,t)},e.prototype._connectBroker=function(){var e=this;this.broker=new i.TcpSocket(this.options.brokerPort,"127.0.0.1"),this.broker.on("message",function(t){if("_0"===t)return e.broker.send("_1");e.emit("publish",JSON.parse(t))}),this.broker.on("disconnect",function(){console.log("Broker disconnected")}),this.broker.on("error",function(e){process.send(a.MessageFactory.processMessages("error",a.MessageFactory.processErrors(e.toString(),"Worker",process.pid)))})},e.prototype._connectHttpServer=function(){var e=this;this.httpServer=n.createServer(),this.httpServer.listen(this.options.port,function(){console.log("[36m%s[0m","          Worker: "+e.options.id+", PID "+process.pid)})},e.prototype._connectWebSocketServer=function(){var e=this,t=new s.Server({server:this.httpServer});t.on("connection",function(t){var r=new o.Socket(t,e);e.emit("connect",r)}),this.webSocketServer=t,this.webSocketServer.on=function(t,r){e.on(t,r)},this.webSocketServer.publish=function(t,r){e.broker.send(a.MessageFactory.brokerMessage(t,r)),e.emit("publish",{channel:t,data:r})}},e}();t.Worker=u},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("uws")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),s=r(1),o=function(){function e(e,t){this._socket=e,this.server=t,this.missedPing=0,this.eventsEmitter=new s.EventEmitter,this.channelsEmitter=new s.EventEmitter,this._runPing(),this._connectPublishEvent(),this._listenOnMessages(),this._listenOnError(),this._listenOnClose()}return e.prototype.on=function(e,t){this.eventsEmitter.on(e,t)},e.prototype.send=function(e,t,r){switch(r){case"ping":this._socket.send(e);break;case"internal":this._socket.send(n.MessageFactory.internalMessage(e,t));break;case"publish":this._socket.send(n.MessageFactory.publishMessage(e,t));break;default:this._socket.send(n.MessageFactory.emitMessage(e,t))}},e.prototype.disconnect=function(e,t){return this._socket.close(e,t)},e.prototype._runPing=function(){var e=this;this.send("config",{pingInterval:this.server.options.pingInterval},"internal"),this.pingPongInterval=setInterval(function(){if(e.missedPing>=2)return e.disconnect(3001,"Did not get pong");e.send("_0",null,"ping"),e.missedPing++},this.server.options.pingInterval)},e.prototype._connectPublishEvent=function(){var e=this;this.publishListener=function(t){e.channelsEmitter.emit(t.channel,t.data)},this.server.on("publish",this.publishListener)},e.prototype._listenOnMessages=function(){var e=this;this._socket.on("message",function(t){if("_1"===t)return e.missedPing=0;try{t=JSON.parse(t)}catch(t){return e.disconnect(1007)}switch(t.action){case"emit":e.eventsEmitter.emit(t.event,t.data);break;case"publish":e.channelsEmitter.exist(t.channel)&&e.server.webSocketServer.publish(t.channel,t.data);break;case"internal":"subscribe"===t.event&&e.channelsEmitter.on(t.data,function(r){e.send(t.data,r,"publish")}),"unsubscribe"===t.event&&e.channelsEmitter.removeEvent(t.data)}})},e.prototype._listenOnError=function(){var e=this;this._socket.on("error",function(t){e.eventsEmitter.emit("error",t)})},e.prototype._listenOnClose=function(){var e=this;this._socket.on("close",function(t,r){e.eventsEmitter.emit("disconnect",t,r),clearInterval(e.pingPongInterval),e.server._unsubscribe("publish",e.publishListener),e.eventsEmitter.removeAllEvents(),e.channelsEmitter.removeAllEvents();for(var n in e)e.hasOwnProperty(n)&&(e[n]=null,delete e[n])})},e}();t.Socket=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),s=r(2),o=r(0),i=function(){function e(e){var t=this;this.options=e,this.servers=[],console.log("[36m%s[0m",">>> Broker on: "+this.options.brokerPort+", PID "+process.pid),this.brokerServer=n.createServer(),this.brokerServer.listen(this.options.brokerPort),this.brokerServer.on("connection",function(e){e=new s.TcpSocket(e);var r=t.servers.length;e.id=r,e.pingInterval=setInterval(function(){e.send("_0")},5e3),t.servers[r]=e,e.on("message",function(r){"_1"!==r&&t.broadcast(e.id,r)}),e.on("disconnect",function(){console.log("socket disconnected")}),e.on("error",function(e){process.send(o.MessageFactory.processMessages("error",o.MessageFactory.processErrors(e.toString(),"Broker",process.pid)))})})}return e.prototype.broadcast=function(e,t){for(var r=0,n=this.servers.length;r<n;r++)e!==r&&this.servers[r].send(t)},e}();t.Broker=i}]);