module.exports=function(e){function t(n){if(r[n])return r[n].exports;var s=r[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.type=e,this.data=t}return e}();t.ProcessMessages=n;var s=function(){function e(e,t,r){this.err=e,this.is=t,this.pid=r}return e}();t.ProcessErrors=s;var o=function(){function e(e,t){this.event=e,this.data=t,this.action="emit"}return e}(),i=function(){function e(e,t){this.channel=e,this.data=t,this.action="publish"}return e}(),c=function(){function e(e,t){this.event=e,this.data=t,this.action="internal"}return e}(),a=function(){function e(e,t){this.channel=e,this.data=t}return e}(),u=function(){function e(){}return e.emitMessage=function(e,t){return JSON.stringify(new o(e,t))},e.publishMessage=function(e,t){return JSON.stringify(new i(e,t))},e.brokerMessage=function(e,t){return JSON.stringify(new a(e,t))},e.internalMessage=function(e,t){return JSON.stringify(new c(e,t))},e.processErrors=function(e,t,r){return new s(e,t,r)},e.processMessages=function(e,t){return new n(e,t)},e}();t.MessageFactory=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._events={}}return e.prototype.on=function(e,t){if(!t)throw"Function must be provided";return this._events[e]||(this._events[e]=[]),this._events[e].push(t)},e.prototype.emit=function(e,t,r,n){if(this._events[e])for(var s=0,o=this._events[e].length;s<o;s++)"function"==typeof this._events[e][s]&&this._events[e][s].call(this,t,r,n)},e.prototype.removeListener=function(e,t){if(this._events[e])for(var r=this._events[e].length;r--;)this._events[e][r]===t&&this._events[e].splice(r,1)},e.prototype.removeEvent=function(e){this._events[e]&&(this._events[e]=null,delete this._events[e])},e.prototype.removeAllEvents=function(){for(var e in this._events)this._events.hasOwnProperty(e)&&(this._events[e]=null,delete this._events[e])},e.prototype.exist=function(e){return this._events[e]},e}();t.EventEmitter=n},function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(3),i=function(e){function t(t,r){var n=e.call(this)||this;return n.port=t,n.host=r,n.dataBuffer="",t instanceof o.Socket?n.socket=t:n.socket=o.connect(t,r),n.socket.on("connect",function(){n.emit("connect")}),n.socket.on("data",function(e){var t=e.toString(),r=t.indexOf("\n");if(-1===r)return void(n.dataBuffer+=t);n.emit("message",n.dataBuffer+t.slice(0,r));for(var s=r+1;-1!==(r=e.indexOf("\n",s));)n.emit("message",t.slice(s,r)),s=r+1;n.dataBuffer=t.slice(s)}),n.socket.on("end",function(){n.emit("disconnect")}),n.socket.on("error",function(e){n.emit("error",e)}),n}return n(t,e),t.prototype.send=function(e){this.socket.write(e+"\n")},t}(s.EventEmitter);t.TcpSocket=i},function(e,t){e.exports=require("net")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(5),s=r(6),o=r(13),i=function(){function e(t){e._instance||(e._instance=this,t.pathToWorker=n.getPath()[1].getFileName(),t=t||{},this.options=new o.Options(t),this.servers=s.Servers(this.options))}return e}();t.ClusterWS=i},function(e,t,r){"use strict";function n(){var e=Error.prepareStackTrace;Error.prepareStackTrace=function(e,t){return t};var t=(new Error).stack.slice(1);return Error.prepareStackTrace=e,t}Object.defineProperty(t,"__esModule",{value:!0}),t.getPath=n},function(module,exports,__webpack_require__){"use strict";function Servers(options){if(cluster.isMaster){var broker=void 0,workers_1,initWorkerMsg_1;console.log("[36m%s[0m",">>> Master on: "+options.port+", PID "+process.pid);var launchWorker_1=function(e){var t=workers_1[e]=cluster.fork();initWorkerMsg_1.data.id=e,t.on("exit",function(){options.restartWorkerOnFail&&(console.log("[33m%s[0m","Restarting worker on fail "+initWorkerMsg_1.data.id),launchWorker_1(e))}),t.send(initWorkerMsg_1)};broker=cluster.fork(),broker.send(messages_1.MessageFactory.processMessages("initBroker",options)),workers_1=new Array(options.workers),initWorkerMsg_1=messages_1.MessageFactory.processMessages("initWorker",options);for(var i=0;i<options.workers;i++)launchWorker_1(i)}else{var server;process.on("message",function(message){"initBroker"===message.type&&(server=new broker_1.Broker(message.data),server.is="Broker"),"initWorker"===message.type&&(server=new worker_1.Worker(message.data),server.is="Worker",eval("require")(message.data.pathToWorker).Worker(server))}),process.on("uncaughtException",function(e){console.log("[31m%s[0m",server.is+", PID "+process.pid+"\n"+e+"\n"),process.exit()})}}Object.defineProperty(exports,"__esModule",{value:!0});var cluster=__webpack_require__(7),worker_1=__webpack_require__(8),broker_1=__webpack_require__(12),messages_1=__webpack_require__(0);exports.Servers=Servers},function(e,t){e.exports=require("cluster")},function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0});var s=r(9),o=r(10),i=r(11),c=r(2),a=r(1),u=r(0),p=function(e){function t(t){var r=e.call(this)||this;return r.options=t,r.id=r.options.id,r._connectBroker(),r._connectHttpServer(),r._connectWebSocketServer(),r}return n(t,e),t.prototype._connectBroker=function(){var e=this;this.broker=new c.TcpSocket(this.options.brokerPort,"127.0.0.1"),this.broker.on("message",function(t){if("_0"===t)return e.broker.send("_1");e.emit("publish",JSON.parse(t))}),this.broker.on("disconnect",function(){console.log("[31m%s[0m","Broker has been disconnected")}),this.broker.on("error",function(e){console.log("[31m%s[0m","Worker, PID "+process.pid+"\n"+e+"\n")})},t.prototype._connectHttpServer=function(){var e=this;this.httpServer=s.createServer(),this.httpServer.listen(this.options.port,function(){console.log("[36m%s[0m","          Worker: "+e.options.id+", PID "+process.pid)})},t.prototype._connectWebSocketServer=function(){var e=this,t=new o.Server({server:this.httpServer});t.on("connection",function(t){var r=new i.Socket(t,e);e.emit("connect",r)}),this.webSocketServer=t,this.webSocketServer.on=function(t,r){e.on(t,r)},this.webSocketServer.publish=function(t,r){e.broker.send(u.MessageFactory.brokerMessage(t,r)),e.emit("publish",{channel:t,data:r})}},t}(a.EventEmitter);t.Worker=p},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("uws")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),s=r(1),o=function(){function e(e,t){this._socket=e,this.server=t,this.missedPing=0,this.eventsEmitter=new s.EventEmitter,this.channelsEmitter=new s.EventEmitter,this._runPing(),this._connectPublishEvent(),this._listenOnMessages(),this._listenOnError(),this._listenOnClose()}return e.prototype.on=function(e,t){this.eventsEmitter.on(e,t)},e.prototype.send=function(e,t,r){switch(r){case"ping":this._socket.send(e);break;case"internal":this._socket.send(n.MessageFactory.internalMessage(e,t));break;case"publish":this._socket.send(n.MessageFactory.publishMessage(e,t));break;default:this._socket.send(n.MessageFactory.emitMessage(e,t))}},e.prototype.disconnect=function(e,t){return this._socket.close(e,t)},e.prototype._runPing=function(){var e=this;this.send("config",{pingInterval:this.server.options.pingInterval},"internal"),this.pingPongInterval=setInterval(function(){if(e.missedPing>=2)return e.disconnect(3001,"Did not get pong");e.send("_0",null,"ping"),e.missedPing++},this.server.options.pingInterval)},e.prototype._connectPublishEvent=function(){var e=this;this.publishListener=function(t){e.channelsEmitter.emit(t.channel,t.data)},this.server.on("publish",this.publishListener)},e.prototype._listenOnMessages=function(){var e=this;this._socket.on("message",function(t){if("_1"===t)return e.missedPing=0;try{t=JSON.parse(t)}catch(t){return e.disconnect(1007)}switch(t.action){case"emit":e.eventsEmitter.emit(t.event,t.data);break;case"publish":e.channelsEmitter.exist(t.channel)&&e.server.webSocketServer.publish(t.channel,t.data);break;case"internal":"subscribe"===t.event&&e.channelsEmitter.on(t.data,function(r){e.send(t.data,r,"publish")}),"unsubscribe"===t.event&&e.channelsEmitter.removeEvent(t.data)}})},e.prototype._listenOnError=function(){var e=this;this._socket.on("error",function(t){e.eventsEmitter.emit("error",t)})},e.prototype._listenOnClose=function(){var e=this;this._socket.on("close",function(t,r){e.eventsEmitter.emit("disconnect",t,r),clearInterval(e.pingPongInterval),e.server.removeListener("publish",e.publishListener),e.eventsEmitter.removeAllEvents(),e.channelsEmitter.removeAllEvents();for(var n in e)e.hasOwnProperty(n)&&(e[n]=null,delete e[n])})},e}();t.Socket=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),s=r(2),o=function(){function e(e){var t=this;this.options=e,this.servers=[],console.log("[36m%s[0m",">>> Broker on: "+this.options.brokerPort+", PID "+process.pid),this.brokerServer=n.createServer(),this.brokerServer.listen(this.options.brokerPort),this.brokerServer.on("connection",function(e){e=new s.TcpSocket(e);var r=t.servers.length;e.id=r,e.pingInterval=setInterval(function(){e.send("_0")},5e3),t.servers[r]=e,e.on("message",function(r){"_1"!==r&&t.broadcast(e.id,r)}),e.on("disconnect",function(){console.log("socket disconnected")}),e.on("error",function(e){console.error("[31m%s[0m","Broker, PID "+process.pid+"\n"+e+"\n")})})}return e.prototype.broadcast=function(e,t){for(var r=0,n=this.servers.length;r<n;r++)e!==r&&this.servers[r].send(t)},e}();t.Broker=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(14),s=function(){function e(e){this.port=e.port||3e3,this.workers=e.workers||1,this.brokerPort=e.brokerPort||9346,this.pathToWorker=n.resolve(e.pathToWorker),this.pingInterval=e.pingInterval||2e4,this.restartWorkerOnFail=e.restartWorkerOnFail||!1}return e}();t.Options=s},function(e,t){e.exports=require("path")}]);