module.exports=function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.type=e,this.data=t}return e}();t.ProcessMessages=r;var o=function(){function e(e,t,n){this.err=e,this.is=t,this.pid=n}return e}();t.ProcessErrors=o;var s=function(){function e(e,t){this.event=e,this.data=t,this.action="emit"}return e}(),i=function(){function e(e,t){this.channel=e,this.data=t,this.action="publish"}return e}(),c=function(){function e(e,t){this.event=e,this.data=t,this.action="internal"}return e}(),u=function(){function e(e,t){this.channel=e,this.data=t}return e}(),a=function(){function e(){}return e.emitMessage=function(e,t){return JSON.stringify(new s(e,t))},e.publishMessage=function(e,t){return JSON.stringify(new i(e,t))},e.brokerMessage=function(e,t){return JSON.stringify(new u(e,t))},e.internalMessage=function(e,t){return JSON.stringify(new c(e,t))},e.processErrors=function(e,t,n){return new o(e,t,n)},e.processMessages=function(e,t){return new r(e,t)},e}();t.MessageFactory=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this._events={}}return e.prototype.on=function(e,t){if(!t)throw"Function must be provided";return this._events[e]||(this._events[e]=[]),this._events[e].push(t)},e.prototype.emit=function(e,t,n,r){if(this._events[e])for(var o=0,s=this._events[e].length;o<s;o++)"function"==typeof this._events[e][o]&&this._events[e][o].call(this,t,n,r)},e.prototype.removeListener=function(e,t){if(this._events[e])for(var n=this._events[e].length;n--;)this._events[e][n]===t&&this._events[e].splice(n,1)},e.prototype.removeEvent=function(e){this._events[e]&&(this._events[e]=null,delete this._events[e])},e.prototype.removeAllEvents=function(){for(var e in this._events)this._events.hasOwnProperty(e)&&(this._events[e]=null,delete this._events[e])},e.prototype.exist=function(e){return this._events[e]},e}();t.EventEmitter=r},function(e,t){e.exports=require("cluster")},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),s=n(4),i=function(e){function t(t,n){var r=e.call(this)||this;return r.port=t,r.host=n,r.dataBuffer="",t instanceof s.Socket?r.socket=t:r.socket=s.connect(t,n),r.socket.on("connect",function(){r.emit("connect")}),r.socket.on("data",function(e){var t=e.toString(),n=t.indexOf("\n");if(-1===n)return void(r.dataBuffer+=t);r.emit("message",r.dataBuffer+t.slice(0,n));for(var o=n+1;-1!==(n=e.indexOf("\n",o));)r.emit("message",t.slice(o,n)),o=n+1;r.dataBuffer=t.slice(o)}),r.socket.on("end",function(){r.emit("disconnect")}),r.socket.on("error",function(e){r.emit("error",e)}),r}return r(t,e),t.prototype.send=function(e){this.socket.write(e+"\n")},t}(o.EventEmitter);t.TcpSocket=i},function(e,t){e.exports=require("net")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),o=n(6),s=n(7),i=n(13),c=function(){function e(t){this.configurations=t,e._instance||(e._instance=this,this.configurations=this.configurations||{},this.options=new i.Options(this.configurations),r.isMaster?o.processMaster(this.options):s.processWorker(this.options))}return e}();t.ClusterWS=c},function(e,t,n){"use strict";function r(e){var t,n;console.log("[36m%s[0m",">>> Master on: "+e.port+", PID "+process.pid);var r=function(t){var i=n[t]=o.fork();i.on("exit",function(){e.restartWorkerOnFail&&(console.log("[33m%s[0m","Restarting worker "+t+" on fail "),r(t))}),i.send(s.MessageFactory.processMessages("initWorker",t))};t=o.fork(),t.send(s.MessageFactory.processMessages("initBroker")),n=new Array(e.workers);for(var i=0;i<e.workers;i++)r(i)}Object.defineProperty(t,"__esModule",{value:!0});var o=n(2),s=n(0);t.processMaster=r},function(e,t,n){"use strict";function r(e){var t;process.on("message",function(n){"initBroker"===n.type&&(t=new s.Broker(e),t.is="Broker"),"initWorker"===n.type&&(e.id=n.data,t=new o.Worker(e),t.is="Worker",e.worker.call(t))}),process.on("uncaughtException",function(e){console.log("[31m%s[0m",t.is+", PID "+process.pid+"\n"+e+"\n"),process.exit()})}Object.defineProperty(t,"__esModule",{value:!0});var o=n(8),s=n(12);t.processWorker=r},function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(9),s=n(10),i=n(11),c=n(3),u=n(1),a=n(0),p=function(e){function t(t){var n=e.call(this)||this;return n.options=t,n.id=n.options.id,n._connectBroker(),n._connectHttpServer(),n._connectWebSocketServer(),n}return r(t,e),t.prototype._connectBroker=function(){var e=this;this.broker=new c.TcpSocket(this.options.brokerPort,"127.0.0.1"),this.broker.on("message",function(t){if("_0"===t)return e.broker.send("_1");e.emit("publish",JSON.parse(t))}),this.broker.on("disconnect",function(){console.log("[31m%s[0m","Broker has been disconnected")}),this.broker.on("error",function(e){console.log("[31m%s[0m","Worker, PID "+process.pid+"\n"+e+"\n")})},t.prototype._connectHttpServer=function(){var e=this;this.httpServer=o.createServer(),this.httpServer.listen(this.options.port,function(){console.log("[36m%s[0m","          Worker: "+e.options.id+", PID "+process.pid)})},t.prototype._connectWebSocketServer=function(){var e=this,t=new s.Server({server:this.httpServer});t.on("connection",function(t){var n=new i.Socket(t,e);e.emit("connect",n)}),this.webSocketServer=t,this.webSocketServer.on=function(t,n){e.on(t,n)},this.webSocketServer.publish=function(t,n){e.broker.send(a.MessageFactory.brokerMessage(t,n)),e.emit("publish",{channel:t,data:n})}},t}(u.EventEmitter);t.Worker=p},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("uws")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=n(1),s=function(){function e(e,t){this._socket=e,this.server=t,this.missedPing=0,this.eventsEmitter=new o.EventEmitter,this.channelsEmitter=new o.EventEmitter,this._runPing(),this._connectPublishEvent(),this._listenOnMessages(),this._listenOnError(),this._listenOnClose()}return e.prototype.on=function(e,t){this.eventsEmitter.on(e,t)},e.prototype.send=function(e,t,n){switch(n){case"ping":this._socket.send(e);break;case"internal":this._socket.send(r.MessageFactory.internalMessage(e,t));break;case"publish":this._socket.send(r.MessageFactory.publishMessage(e,t));break;default:this._socket.send(r.MessageFactory.emitMessage(e,t))}},e.prototype.disconnect=function(e,t){return this._socket.close(e,t)},e.prototype._runPing=function(){var e=this;this.send("config",{pingInterval:this.server.options.pingInterval},"internal"),this.pingPongInterval=setInterval(function(){if(e.missedPing>=2)return e.disconnect(3001,"Did not get pong");e.send("_0",null,"ping"),e.missedPing++},this.server.options.pingInterval)},e.prototype._connectPublishEvent=function(){var e=this;this.publishListener=function(t){e.channelsEmitter.emit(t.channel,t.data)},this.server.on("publish",this.publishListener)},e.prototype._listenOnMessages=function(){var e=this;this._socket.on("message",function(t){if("_1"===t)return e.missedPing=0;try{t=JSON.parse(t)}catch(t){return e.disconnect(1007)}switch(t.action){case"emit":e.eventsEmitter.emit(t.event,t.data);break;case"publish":e.channelsEmitter.exist(t.channel)&&e.server.webSocketServer.publish(t.channel,t.data);break;case"internal":"subscribe"===t.event&&e.channelsEmitter.on(t.data,function(n){e.send(t.data,n,"publish")}),"unsubscribe"===t.event&&e.channelsEmitter.removeEvent(t.data)}})},e.prototype._listenOnError=function(){var e=this;this._socket.on("error",function(t){e.eventsEmitter.emit("error",t)})},e.prototype._listenOnClose=function(){var e=this;this._socket.on("close",function(t,n){e.eventsEmitter.emit("disconnect",t,n),clearInterval(e.pingPongInterval),e.server.removeListener("publish",e.publishListener),e.eventsEmitter.removeAllEvents(),e.channelsEmitter.removeAllEvents();for(var r in e)e.hasOwnProperty(r)&&(e[r]=null,delete e[r])})},e}();t.Socket=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),o=n(3),s=function(){function e(e){var t=this;this.options=e,this.servers=[],console.log("[36m%s[0m",">>> Broker on: "+this.options.brokerPort+", PID "+process.pid),this.brokerServer=r.createServer(),this.brokerServer.listen(this.options.brokerPort),this.brokerServer.on("connection",function(e){e=new o.TcpSocket(e);var n=t.servers.length;e.id=n,e.pingInterval=setInterval(function(){e.send("_0")},5e3),t.servers[n]=e,e.on("message",function(n){"_1"!==n&&t.broadcast(e.id,n)}),e.on("disconnect",function(){console.log("socket disconnected")}),e.on("error",function(e){console.error("[31m%s[0m","Broker, PID "+process.pid+"\n"+e+"\n")})})}return e.prototype.broadcast=function(e,t){for(var n=0,r=this.servers.length;n<r;n++)e!==n&&this.servers[n].send(t)},e}();t.Broker=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){if(!e.worker)throw"\n[31mWorker function must be provided[0m";this.port=e.port||3e3,this.worker=e.worker,this.workers=e.workers||1,this.brokerPort=e.brokerPort||9346,this.pingInterval=e.pingInterval||2e4,this.restartWorkerOnFail=e.restartWorkerOnFail||!1}return e}();t.Options=r}]);